/*! mule-uploader - v1.2.0 - 2016-09-21
* https://github.com/cinely/mule-uploader
* Copyright (c) 2016 gabipurcaru; Licensed MIT */
!function(a){var b=b||function(a,b){var c={},d=c.lib={},e=function(){},f=d.Base={extend:function(a){e.prototype=this;var b=new e;return a&&b.mixIn(a),b.hasOwnProperty("init")||(b.init=function(){b.$super.init.apply(this,arguments)}),b.init.prototype=b,b.$super=this,b},create:function(){var a=this.extend();return a.init.apply(a,arguments),a},init:function(){},mixIn:function(a){for(var b in a)a.hasOwnProperty(b)&&(this[b]=a[b]);a.hasOwnProperty("toString")&&(this.toString=a.toString)},clone:function(){return this.init.prototype.extend(this)}},g=d.WordArray=f.extend({init:function(a,c){a=this.words=a||[],this.sigBytes=c!=b?c:4*a.length},toString:function(a){return(a||i).stringify(this)},concat:function(a){var b=this.words,c=a.words,d=this.sigBytes;if(a=a.sigBytes,this.clamp(),d%4)for(var e=0;e<a;e++)b[d+e>>>2]|=(c[e>>>2]>>>24-8*(e%4)&255)<<24-8*((d+e)%4);else if(65535<c.length)for(e=0;e<a;e+=4)b[d+e>>>2]=c[e>>>2];else b.push.apply(b,c);return this.sigBytes+=a,this},clamp:function(){var b=this.words,c=this.sigBytes;b[c>>>2]&=4294967295<<32-8*(c%4),b.length=a.ceil(c/4)},clone:function(){var a=f.clone.call(this);return a.words=this.words.slice(0),a},random:function(b){for(var c=[],d=0;d<b;d+=4)c.push(4294967296*a.random()|0);return new g.init(c,b)}}),h=c.enc={},i=h.Hex={stringify:function(a){var b=a.words;a=a.sigBytes;for(var c=[],d=0;d<a;d++){var e=b[d>>>2]>>>24-8*(d%4)&255;c.push((e>>>4).toString(16)),c.push((15&e).toString(16))}return c.join("")},parse:function(a){for(var b=a.length,c=[],d=0;d<b;d+=2)c[d>>>3]|=parseInt(a.substr(d,2),16)<<24-4*(d%8);return new g.init(c,b/2)}},j=h.Latin1={stringify:function(a){var b=a.words;a=a.sigBytes;for(var c=[],d=0;d<a;d++)c.push(String.fromCharCode(b[d>>>2]>>>24-8*(d%4)&255));return c.join("")},parse:function(a){for(var b=a.length,c=[],d=0;d<b;d++)c[d>>>2]|=(255&a.charCodeAt(d))<<24-8*(d%4);return new g.init(c,b)}},k=h.Utf8={stringify:function(a){try{return decodeURIComponent(escape(j.stringify(a)))}catch(a){throw Error("Malformed UTF-8 data")}},parse:function(a){return j.parse(unescape(encodeURIComponent(a)))}},l=d.BufferedBlockAlgorithm=f.extend({reset:function(){this._data=new g.init,this._nDataBytes=0},_append:function(a){"string"==typeof a&&(a=k.parse(a)),this._data.concat(a),this._nDataBytes+=a.sigBytes},_process:function(b){var c=this._data,d=c.words,e=c.sigBytes,f=this.blockSize,h=e/(4*f),h=b?a.ceil(h):a.max((0|h)-this._minBufferSize,0);if(b=h*f,e=a.min(4*b,e),b){for(var i=0;i<b;i+=f)this._doProcessBlock(d,i);i=d.splice(0,b),c.sigBytes-=e}return new g.init(i,e)},clone:function(){var a=f.clone.call(this);return a._data=this._data.clone(),a},_minBufferSize:0});d.Hasher=l.extend({cfg:f.extend(),init:function(a){this.cfg=this.cfg.extend(a),this.reset()},reset:function(){l.reset.call(this),this._doReset()},update:function(a){return this._append(a),this._process(),this},finalize:function(a){return a&&this._append(a),this._doFinalize()},blockSize:16,_createHelper:function(a){return function(b,c){return new a.init(c).finalize(b)}},_createHmacHelper:function(a){return function(b,c){return new m.HMAC.init(a,c).finalize(b)}}});var m=c.algo={};return c}(Math);!function(a){for(var c=b,d=c.lib,e=d.WordArray,f=d.Hasher,d=c.algo,g=[],h=[],i=function(a){return 4294967296*(a-(0|a))|0},j=2,k=0;64>k;){var l;a:{l=j;for(var m=a.sqrt(l),n=2;n<=m;n++)if(!(l%n)){l=!1;break a}l=!0}l&&(8>k&&(g[k]=i(a.pow(j,.5))),h[k]=i(a.pow(j,1/3)),k++),j++}var o=[],d=d.SHA256=f.extend({_doReset:function(){this._hash=new e.init(g.slice(0))},_doProcessBlock:function(a,b){for(var c=this._hash.words,d=c[0],e=c[1],f=c[2],g=c[3],i=c[4],j=c[5],k=c[6],l=c[7],m=0;64>m;m++){if(16>m)o[m]=0|a[b+m];else{var n=o[m-15],p=o[m-2];o[m]=((n<<25|n>>>7)^(n<<14|n>>>18)^n>>>3)+o[m-7]+((p<<15|p>>>17)^(p<<13|p>>>19)^p>>>10)+o[m-16]}n=l+((i<<26|i>>>6)^(i<<21|i>>>11)^(i<<7|i>>>25))+(i&j^~i&k)+h[m]+o[m],p=((d<<30|d>>>2)^(d<<19|d>>>13)^(d<<10|d>>>22))+(d&e^d&f^e&f),l=k,k=j,j=i,i=g+n|0,g=f,f=e,e=d,d=n+p|0}c[0]=c[0]+d|0,c[1]=c[1]+e|0,c[2]=c[2]+f|0,c[3]=c[3]+g|0,c[4]=c[4]+i|0,c[5]=c[5]+j|0,c[6]=c[6]+k|0,c[7]=c[7]+l|0},_doFinalize:function(){var b=this._data,c=b.words,d=8*this._nDataBytes,e=8*b.sigBytes;return c[e>>>5]|=128<<24-e%32,c[(e+64>>>9<<4)+14]=a.floor(d/4294967296),c[(e+64>>>9<<4)+15]=d,b.sigBytes=4*c.length,this._process(),this._hash},clone:function(){var a=f.clone.call(this);return a._hash=this._hash.clone(),a}});c.SHA256=f._createHelper(d),c.HmacSHA256=f._createHmacHelper(d)}(Math),function(a){for(var c=b,d=c.lib,e=d.WordArray,f=d.Hasher,d=c.algo,g=[],h=[],i=function(a){return 4294967296*(a-(0|a))|0},j=2,k=0;64>k;){var l;a:{l=j;for(var m=a.sqrt(l),n=2;n<=m;n++)if(!(l%n)){l=!1;break a}l=!0}l&&(8>k&&(g[k]=i(a.pow(j,.5))),h[k]=i(a.pow(j,1/3)),k++),j++}var o=[],d=d.SHA256=f.extend({_doReset:function(){this._hash=new e.init(g.slice(0))},_doProcessBlock:function(a,b){for(var c=this._hash.words,d=c[0],e=c[1],f=c[2],g=c[3],i=c[4],j=c[5],k=c[6],l=c[7],m=0;64>m;m++){if(16>m)o[m]=0|a[b+m];else{var n=o[m-15],p=o[m-2];o[m]=((n<<25|n>>>7)^(n<<14|n>>>18)^n>>>3)+o[m-7]+((p<<15|p>>>17)^(p<<13|p>>>19)^p>>>10)+o[m-16]}n=l+((i<<26|i>>>6)^(i<<21|i>>>11)^(i<<7|i>>>25))+(i&j^~i&k)+h[m]+o[m],p=((d<<30|d>>>2)^(d<<19|d>>>13)^(d<<10|d>>>22))+(d&e^d&f^e&f),l=k,k=j,j=i,i=g+n|0,g=f,f=e,e=d,d=n+p|0}c[0]=c[0]+d|0,c[1]=c[1]+e|0,c[2]=c[2]+f|0,c[3]=c[3]+g|0,c[4]=c[4]+i|0,c[5]=c[5]+j|0,c[6]=c[6]+k|0,c[7]=c[7]+l|0},_doFinalize:function(){var b=this._data,c=b.words,d=8*this._nDataBytes,e=8*b.sigBytes;return c[e>>>5]|=128<<24-e%32,c[(e+64>>>9<<4)+14]=a.floor(d/4294967296),c[(e+64>>>9<<4)+15]=d,b.sigBytes=4*c.length,this._process(),this._hash},clone:function(){var a=f.clone.call(this);return a._hash=this._hash.clone(),a}});c.SHA256=f._createHelper(d),c.HmacSHA256=f._createHmacHelper(d)}(Math),function(){var a=b,c=a.enc.Utf8;a.algo.HMAC=a.lib.Base.extend({init:function(a,b){a=this._hasher=new a.init,"string"==typeof b&&(b=c.parse(b));var d=a.blockSize,e=4*d;b.sigBytes>e&&(b=a.finalize(b)),b.clamp();for(var f=this._oKey=b.clone(),g=this._iKey=b.clone(),h=f.words,i=g.words,j=0;j<d;j++)h[j]^=1549556828,i[j]^=909522486;f.sigBytes=g.sigBytes=e,this.reset()},reset:function(){var a=this._hasher;a.reset(),a.update(this._iKey)},update:function(a){return this._hasher.update(a),this},finalize:function(a){var b=this._hasher;return a=b.finalize(a),b.reset(),b.finalize(this._oKey.clone().concat(a))}})}(),function(){if(void 0!==typeof ArrayBuffer){var a=b.lib.WordArray,c=a.init;(a.init=function(a){if(a instanceof ArrayBuffer&&(a=new Uint8Array(a)),(a instanceof Int8Array||a instanceof Uint8ClampedArray||a instanceof Int16Array||a instanceof Uint16Array||a instanceof Int32Array||a instanceof Uint32Array||a instanceof Float32Array||a instanceof Float64Array)&&(a=new Uint8Array(a.buffer,a.byteOffset,a.byteLength)),a instanceof Uint8Array){for(var b=a.byteLength,d=[],e=0;e<b;e++)d[e>>>2]|=a[e]<<24-8*(e%4);c.call(this,d,b)}else c.apply(this,arguments)}).prototype=a}}();var c=function(a){a.headers=a.headers||{},a.method=a.method||"GET";var b=new XMLHttpRequest;a.load_callback&&"function"==typeof a.load_callback&&b.addEventListener("load",a.load_callback,!0),a.error_callback&&"function"==typeof a.error_callback&&b.addEventListener("error",a.error_callback,!0),a.state_change_callback&&"function"==typeof a.state_change_callback&&b.addEventListener("readystatechange",a.state_change_callback),a.progress_callback&&"function"==typeof a.progress_callback&&b.upload.addEventListener("progress",a.progress_callback),a.timeout_callback&&"function"==typeof a.timeout_callback&&b.addEventListener("timeout",a.timeout_callback);var c=a.url;if(a.extra_params)for(var d in a.extra_params)a.extra_params.hasOwnProperty(d)&&(c+=c.indexOf("?")!==-1?"&":"?",c+=encodeURIComponent(d)+"=",c+=encodeURIComponent(a.extra_params[d]));b.open(a.method,c);for(var e in a.headers)a.headers.hasOwnProperty(e)&&b.setRequestHeader(e,a.headers[e]);return a.body?b.send(a.body):b.send(),b};a.mule_upload=function(b){function f(a){var b=this;a=a||{},b.input=a.file_input,b.file=a.file,a.autostart=!("autostart"in a)||a.autostart,a.chunk_size=a.chunk_size||6*j,a.max_size=a.max_size||5*k,a.num_workers=a.num_workers||4,a.key=a.key||"the_key",a.bucket=a.bucket,a.access_key=a.access_key,a.content_type=a.content_type||"application/octet-stream",a.acl=a.acl||"public-read",a.on_progress=a.on_progress||function(){},a.on_chunk_progress=a.on_chunk_progress||function(){},a.on_select=a.on_select||function(){},a.on_error=a.on_error||function(){},a.on_complete=a.on_complete||function(){},a.on_init=a.on_init||function(){},a.on_start=a.on_start||function(){},a.on_chunk_uploaded=a.on_chunk_uploaded||function(){},a.ajax_base=a.ajax_base||"/upload-backend",a.accepted_extensions=a.accepted_extensions||"",b.settings=a,b.set_state("waiting"),b.input&&(b.input.onchange=function(a,c){if(!b.settings.autostart)return!0;if("waiting"!=b.get_state())return!1;var d=a.target.files[0];return b.upload_file(d,c),!0}),setTimeout(function(){b.settings.on_init.apply(b)},100)}var g=!0,h=function(){};g&&console&&console.log&&(h=function(){for(var a=["[MuleUploader]"],b=0;b<arguments.length;b++)a.push(arguments[b]);return console.log.apply(console,a)});var i=1024,j=1024*i,k=1024*j;if(File.prototype.slice=File.prototype.webkitSlice||File.prototype.mozSlice||File.prototype.slice,!(a.File&&a.FileList&&a.Blob))return h("HTML5 APIs not available."),-1;if(navigator.userAgent.indexOf("Firefox")!==-1)try{new Blob(["something"])}catch(a){return-1}return h("OK"),f.prototype.start=function(){return this.input&&this.input.files&&this.input.files.length>0?this.upload_file(this.input.files[0],!1):void alert("No file selected")},f.prototype.upload_file=function(a,b){var f=this;if("waiting"!=f.get_state())return!1;if(a&&(f.file=a),!f.file)return!1;if(f.file.lastModifiedDate=f.file.lastModifiedDate||new Date(0),f.file.size>f.settings.max_size)return alert(["The maximum allowed file size is ",f.settings.max_size/k,"GB. Please select another file."].join("")),!1;if(f.settings.accepted_extensions){for(var g=a.name.split(".").pop(),h=f.settings.accepted_extensions.split(","),i=!1,j=0;j<h.length;j++)if(g==h[j]){i=!0;break}if(!i)return alert(["This file format is not accepted. ","Please use a file with an extension like ",f.settings.accepted_extensions].join("")),!1}f.settings.on_select.call(f,a);var l=e.extend_object(f.settings.extra_params||{},{filename:a.name,filesize:a.size,content_type:a.type,last_modified:a.lastModifiedDate.valueOf()});b&&(l.force=!0),c({url:f.settings.ajax_base+"/signing_key/",extra_params:l,load_callback:function(c){var e=JSON.parse(c.target.responseText),g=/Z|\+00:?00$/.test(e.date.toString())?"":"Z";e.date=new Date(e.date+g),f.auth=e,f.upload_id=e.upload_id,f.chunks=e.chunks,f.settings.key=e.key||f.settings.key,f.settings.backup_key=f.settings.key,f.upload_id?b?f.load_file():d.list(f.auth,f.file,f.settings.key,f.upload_id,f.settings.chunk_size,function(a){for(var b=0;b<a.length;b++){var c=a[b][0]-1;f.set_progress(c,f.get_chunk_size(c)),f.set_chunk_finished(c),f.set_chunk_uploading(c,!1)}f.load_file()},function(){f.upload_id=null,this._loaded_chunks=null,f._progress=null,f._total_progress=null,f._loaded_chunks=null,f._uploading_chunks=null,f._chunks=null,f.settings.key=f.settings.backup_key,f.upload_file(a,!0)}):d.init(e,f.settings.key,a,function(a){var b=a.target.responseXML;f.upload_id=b.getElementsByTagName("UploadId")[0].textContent,f.load_file()})}})},f.prototype.load_file=function(){var a=this;if("waiting"==a.get_state()){a._start_fired||(a.settings.on_start.call(a,a.file),a.settings.on_progress.call(a,0,a.file.size),a._start_fired=!0),a.set_state("processing"),a.settings.on_progress.call(a,a.get_total_progress(),a.file.size);var b=a.get_next_chunk();b!=-1?a.upload_chunk(b):a.upload_finished()&&(h("All done; finish upload"),a.finish_upload());for(var c=0;c<a.settings.num_workers-1&&(b=a.get_next_chunk(),b!==-1);c++)a.upload_chunk(b)}},f.prototype.upload_chunk=function(a){var b=this;if("processing"!=b.get_state())return void h("NOT processing; return");if(b.get_chunk_uploading(a))return h("Already Uploading"),void setTimeout(function(){var a=b.get_next_chunk();a!==-1&&b.upload_chunk(b.get_next_chunk())},1e3);if(b.set_chunk_uploading(a),h("Uploading Chunk: "+a),b.is_chunk_loaded(a)){var c=b.get_next_chunk();c!=-1?b.upload_chunk(c):b.upload_finished()&&(h("No next chunk; finish upload"),b.finish_upload())}var e=b.settings.chunk_size,f=a*e,g=Math.min(f+e,b.file.size),i=new Date;b._intervals=b._intervals||{};var j=function(c){if(c.target.readyState!=this.DONE||"processing"!=b.get_state())return void h(c);if(c.target.status/100!=2)return m();h("Chunk uploaded: "+a),b.notify_chunk_uploaded(a),b.settings.on_chunk_uploaded.call(b,a),clearInterval(b._intervals[a]),b.set_progress(a,b.get_chunk_size(a)),b.set_chunk_finished(a),b.set_chunk_uploading(a,!1);var d=b.get_next_chunk();if(d!=-1)b.upload_chunk(d);else if(b.upload_finished())h("Done"),b.finish_upload();else var e=setInterval(function(){var a=b.get_next_chunk();a!=-1?(clearInterval(e),b.upload_chunk(a)):b.upload_finished()&&(clearInterval(e),b.finish_upload())},1e3)},k=function(c){b.set_progress(a,c.loaded),b.settings.on_progress.call(b,b.get_total_progress(),b.file.size),i=new Date},l=!1,m=function(){var c=arguments,d=this;b.check_already_uploaded(function(){b.set_state("finished"),b.notify_upload_finished(),b.settings.on_progress.call(b,b.file.size,b.file.size),b.settings.on_complete.call(b)},function(){if(h("Error: "),h(c),!l){l=!0,b.set_chunk_uploading(a,!1),b.set_chunk_finished(a,!1),b.set_progress(a,0),h("Abort");try{d.abort()}catch(a){h(a)}h("Retry chunk: "+a),clearInterval(b._intervals[a]),setTimeout(function(){if("processing"==b.get_state()){var c=b.get_next_chunk(a);c!==-1&&b.upload_chunk(c)}},1e3)}})};d.upload_chunk(b.auth,b.settings.key,b.upload_id,a,b.file.slice(f,g),{progress_callback:k,state_change_callback:j,error_callback:m,timeout_callback:m},function(c){b._chunk_xhr=b._chunk_xhr||[],b._chunk_xhr.push(c),b._intervals[a]=setInterval(function(){i&&new Date-i>15e3&&(h("Chunk Failed; retry"),clearInterval(b._intervals[a]),"processing"==b.get_state()&&(c.abort(),m.call(c),b._chunk_xhr[b._chunk_xhr.indexOf(c)]=null))},4e3)})},f.prototype.finish_upload=function(){var a=this;if("processing"==a.get_state()){a.set_state("finishing"),a.settings.on_progress.call(a,a.file.size,a.file.size);var b=function(c){c.target.status/100==2?(h("Finished file."),a.set_state("finished"),a.settings.on_progress.call(a,a.file.size,a.file.size),a.settings.on_complete.call(a)):400==c.target.status&&c.target.responseText.indexOf("EntityTooSmall")!==-1?d.list(a.auth,a.file,a.settings.key,a.upload_id,a.settings.chunk_size,function(b){a.update_chunks(b);var c=a.get_next_chunk();a.set_state("processing"),a.upload_chunk(c)}):404==c.target.status?a.cancel(function(){a.upload_file(a.file,!0)}):a.check_already_uploaded(function(){b({target:{status:200}})},function(){b({target:{status:404}})})};d.list(a.auth,a.file,a.settings.key,a.upload_id,a.settings.chunk_size,function(c){var e=Math.ceil(a.file.size/a.settings.chunk_size);if(c.length!=e){a.update_chunks(c);var f=a.get_next_chunk();return a.set_state("processing"),void a.upload_chunk(f)}d.finish(a.auth,a.file,a.settings.key,a.upload_id,c,a.settings.chunk_size,b,b)})}},f.prototype.notify_chunk_uploaded=function(a){var b=this;if("processing"==b.get_state()){var d=b.settings.key,f=b.upload_id,g=b.settings.ajax_base+"/chunk_loaded/",h=e.extend_object(b.settings.extra_params||{},{chunk:a,key:d,upload_id:f,filename:b.file.name,filesize:b.file.size,content_type:b.file.type,last_modified:b.file.lastModifiedDate.valueOf()});c({url:g,extra_params:h})}},f.prototype.check_already_uploaded=function(a,b){var d=this,f="HEAD",g="/"+d.settings.key,i=function(c){c.target.status/100==2?(h("Already Uploaded"),a()):(h("Error!"),b())};b||"function"==typeof b||(b=function(){setTimeout(function(){return d.check_already_uploaded(a,b)},2500)}),console.log(d.settings);var j="s3"+e.region_string(d.settings.region)+".amazonaws.com",k=location.protocol+"//"+j+"/"+d.settings.bucket+"/"+g;c({url:k,method:f,load_callback:i,error_callback:b})},f.prototype.cancel=function(a){for(var b=this,c=0;c<b._chunk_xhr.length;c++)h("Abort chunk: "+b._chunk_xhr[c]),b._chunk_xhr[c].abort();b._intervals=b._intervals||{};for(var d in b._intervals)b._intervals.hasOwnProperty(d)&&clearInterval(b._intervals[d]);a=a||function(){},b.set_state("canceled"),b._chunk_xhr=b._chunk_xhr||[],b.settings.on_progress.call(b,0,0),b._chunk_xhr=null,b._chunks=null,b._uploading_chunks=null,b._loaded_chunks=null,b._start_fired=!1,b.upload_id=null,b._progress=null,b.set_state("waiting"),a()},f.prototype.update_chunks=function(a){var b=this,c=[],d=Math.ceil(b.file.size/b.settings.chunk_size);b._init_chunks(!0),b._uploading_chunks=[],b._loaded_chunks=[];var e;for(e=0;e<a.length;e++){var f=parseInt(a[e][0],10);b.add_loaded_chunk(f-1),b.set_chunk_finished(f-1),c.push(f-1)}for(e=0;e<d;e++)c.indexOf(e)===-1&&(h("Chunk not uploaded: ",e),b.set_progress(e,0))},f.prototype.is_selected=function(){return!!this.file},f.prototype.get_state=function(){return this._state},f.prototype.set_state=function(a){return this._state=a,a},f.prototype.set_progress=function(a,b){this.log_status(),this._progress=this._progress||{},this._total_progress=(this._total_progress||0)+b-(this._progress[a]||0),this._progress[a]=b,this.settings.on_chunk_progress.call(this,a,b,this.get_chunk_size(a))},f.prototype.get_total_progress=function(){return this._total_progress||0},f.prototype.is_chunk_loaded=function(a){return this._loaded_chunks=this._loaded_chunks||[],this._loaded_chunks.indexOf(a)!==-1},f.prototype.add_loaded_chunk=function(a){this._loaded_chunks=this._loaded_chunks||[],this._loaded_chunks.push(a),this.set_progress(a,this.get_chunk_size(a))},f.prototype.get_chunk_uploading=function(a){return this._uploading_chunks=this._uploading_chunks||[],this._uploading_chunks.indexOf(a)!==-1},f.prototype.set_chunk_uploading=function(a,b){if("undefined"==typeof b&&(b=!0),this._uploading_chunks=this._uploading_chunks||[],b)this._uploading_chunks.push(a);else{for(var c=[],d=0;d<this._uploading_chunks.length;d++)this._uploading_chunks[d]!=a&&c.push(this._uploading_chunks[d]);this._uploading_chunks=c}},f.prototype._init_chunks=function(a){var b=this;if(!b._chunks||a){b._chunks=[];for(var c=Math.ceil(b.file.size/b.settings.chunk_size),d=0;d<c;d++)b._chunks.push(!1)}},f.prototype.set_chunk_finished=function(a,b){"undefined"==typeof b&&(b=!0);var c=this;c._init_chunks(),c._chunks[a]=b},f.prototype.get_next_chunk=function(a){var b=this;if(b._init_chunks(),a&&!b._chunks[a]&&!b.get_chunk_uploading(a))return a;for(var c=0;c<b._chunks.length;c++)if(!b._chunks[c]&&!b.get_chunk_uploading(c))return c;return-1},f.prototype.upload_finished=function(){var a=this;a._init_chunks();for(var b=0;b<a._chunks.length;b++)if(!a._chunks[b]||a.get_chunk_uploading(b))return!1;return!0},f.prototype.is_last_chunk=function(a){return Math.ceil(this.file.size/this.settings.chunk_size)-1==a},f.prototype.get_chunk_size=function(a){return this.is_last_chunk(a)?this.file.size%this.settings.chunk_size:this.settings.chunk_size},f.prototype.log_status=function(){},f.prototype.on_chunk_progress=function(a){this.settings.on_chunk_progress=a},f.prototype.on_progress=function(a){this.settings.on_progress=a},f.prototype.on_select=function(a){this.settings.on_select=a},f.prototype.on_error=function(a){this.settings.on_error=a},f.prototype.on_complete=function(a){this.settings.on_complete=a},f.prototype.on_init=function(a){this.settings.on_init=a},f.prototype.on_start=function(a){this.settings.on_start=a},f.prototype.on_chunk_uploaded=function(a){this.settings.on_chunk_uploaded=a},new f(b)};var d=function(a){this.settings=a};d.finish=function(a,b,c,e,f,g,h){for(var i={uploadId:e},j="<CompleteMultipartUpload>",k=0;k<f.length;k++)j+="<Part>",j+="<PartNumber>"+f[k][0]+"</PartNumber>",j+="<ETag>"+f[k][1]+"</ETag>",j+="</Part>";return j+="</CompleteMultipartUpload>",navigator.userAgent.indexOf("Firefox")!==-1&&(j=new Blob([j])),new d({auth:a,key:c,method:"POST",querystring:i,headers:{},payload:j,load_callback:h}).send()},d.list=function(a,b,c,e,f,g,h,i){var j={uploadId:e};return i&&(j["part-numberâ€‹-marker"]=i),new d({auth:a,key:c,method:"GET",querystring:j,headers:{},payload:"",error_callback:h,load_callback:function(i){if(404===i.target.status)return void(h&&h());window.debug=i;for(var j=i.target.responseXML,k=[],l=j.getElementsByTagName("Part"),m=Math.ceil(b.size/f),n=0;n<l.length;n++){var o=parseInt(l[n].getElementsByTagName("PartNumber")[0].textContent,10),p=l[n].getElementsByTagName("ETag")[0].textContent,q=parseInt(l[n].getElementsByTagName("Size")[0].textContent,10);o!=m&&q!=f||o==m&&q!=b.size%f||k.push([o,p,q])}var r=j.getElementsByTagName("IsTruncated")[0].textContent;if("true"===r){var s=j.getElementsByTagName("NextPartNumberMarker")[0].textContent;d.list(a,b,c,e,f,function(a){g(k.concat(a))},h,s)}else g(k)}}).send()},d.upload_chunk=function(a,b,c,e,f,g,h){var i,j,k,l;g instanceof Object?(i=g.load_callback,j=g.error_callback,k=g.progress_callback,l=g.state_change_callback):i=g;var m={partNumber:e+1,uploadId:c};return new d({auth:a,key:b,method:"PUT",querystring:m,headers:{},payload:f,load_callback:i,error_callback:j,progress_callback:k,state_change_callback:l}).send(h)},d.init=function(a,b,c,e){return new d({auth:a,key:b,method:"POST",querystring:{uploads:""},headers:{"x-amz-acl":"public-read","Content-Disposition":"attachment; filename="+encodeURIComponent(c.name),"Content-Type":a.content_type||"application/octet-stream"},payload:"",load_callback:e}).send()},d.prototype={send:function(a){var b=this;b.request_date=new Date,b.headers=b.settings.headers,b.headers.host=b.settings.auth.bucket+".s3"+e.region_string(b.settings.auth.region)+".amazonaws.com";var d=[b.settings.auth.date.getUTCFullYear(),e.zfill(b.settings.auth.date.getUTCMonth()+1,2),e.zfill(b.settings.auth.date.getUTCDate(),2)].join("");b.settings.querystring["X-Amz-Date"]=e.uriencode(e.iso8601(b.request_date)),b.settings.querystring["X-Amz-Algorithm"]="AWS4-HMAC-SHA256",b.settings.querystring["X-Amz-Expires"]=86400,b.settings.querystring["X-Amz-Credential"]=e.uriencode([b.settings.auth.access_key,"/"+d+"/",b.settings.auth.region+"/s3/aws4_request"].join("")),b.settings.querystring["X-Amz-SignedHeaders"]="";var f=[];for(var g in b.headers)f.push(g);f.sort(),b.settings.querystring["X-Amz-SignedHeaders"]=e.uriencode(f.join(";")),b.settings.querystring["X-Amz-Signature"]=b.get_authorization_header();var h=location.protocol+"//"+b.headers.host+"/"+b.settings.key;delete b.headers.host;var i=!0;for(var g in b.settings.querystring)b.settings.querystring.hasOwnProperty(g)&&(i&&(h+="?"),i=!1,h+=g+"="+b.settings.querystring[g]+"&");h=h.slice(0,-1);var j=c({url:h,method:b.settings.method,headers:b.headers,body:b.settings.payload,load_callback:b.settings.load_callback,progress_callback:b.settings.progress_callback,state_change_callback:b.settings.state_change_callback,error_callback:b.settings.error_callback,timeout_callback:b.settings.timeout_callback});a&&a(j)},get_authorization_header:function(){if(!this.settings.auth.date)throw"Invalid date given.";for(var a=e.get_sorted_keys(this.headers),b="",c=0;c<a.length;c++)b+=a[c].toLowerCase()+";";b=b.slice(0,-1);var d=this.get_canonical_request(),f=this.get_string_to_sign(d,this.request_date),g=this.sign_request(f);return g},get_canonical_request:function(){var a="";a+=this.settings.method.toUpperCase()+"\n",a+="/"+e.uriencode(this.settings.key).replace(/%2F/g,"/")+"\n";var b,c,d,f=e.get_sorted_keys(this.settings.querystring);for(d=0;d<f.length;d++)b=f[d],c=this.settings.querystring[b],a+=e.uriencode(b)+"="+c+"&amp;";a=a.slice(0,-"&amp;".length)+"\n";var g=e.get_sorted_keys(this.headers);for(d=0;d<g.length;d++)b=g[d],c=this.headers[b],a+=b.toLowerCase()+":"+c.trim()+"\n";for(a+="\n",d=0;d<g.length;d++)a+=g[d].toLowerCase()+";";return a=a.slice(0,-1)+"\n",a+="UNSIGNED-PAYLOAD"},get_string_to_sign:function(a,c){var d="";return d+="AWS4-HMAC-SHA256\n",d+=e.iso8601(c)+"\n",d+=[c.getUTCFullYear(),e.zfill(c.getUTCMonth()+1,2),e.zfill(c.getUTCDate(),2),"/"+this.settings.auth.region+"/s3/aws4_request\n"].join(""),d+=b.SHA256(a.replace(/&amp;/g,"&")).toString()},sign_request:function(a){if(!this.settings.auth.signature)throw"No signature provided.";var c=b.HmacSHA256(a,b.enc.Hex.parse(this.settings.auth.signature)).toString();return c}};var e={uriencode:function(a){var b=encodeURIComponent(a);return b=b.replace(/[^A-Za-z0-9_.~\-%]+/g,escape),b=b.replace(/;/g,"%3B"),b=b.replace(/[*]/g,function(a){return"%"+a.charCodeAt(0).toString(16).toUpperCase()})},get_sorted_keys:function(a){var b=[];for(var c in a)a.hasOwnProperty(c)&&b.push(c);return b.sort()},iso8601:function(a){return[a.getUTCFullYear(),e.zfill(a.getUTCMonth()+1,2),e.zfill(a.getUTCDate(),2),"T",e.zfill(a.getUTCHours(),2),e.zfill(a.getUTCMinutes(),2),e.zfill(a.getUTCSeconds(),2),"Z"].join("")},zfill:function(a,b){return("00000000000"+a).substr(-b)},region_string:function(a){return a&&"us"!==a.slice(0,2)?"-"+a:""},extend_object:function(a,b){var c=a;for(var d in b)c[d]=b[d];return c}}}(this);