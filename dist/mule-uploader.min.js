/*! mule-uploader - v1.2.0 - 2016-09-28
* https://github.com/cinely/mule-uploader
* Copyright (c) 2016 Gabi Purcaru; Licensed MIT */
!function(a){var b=function(a){a.headers=a.headers||{},a.method=a.method||"GET";var b=new XMLHttpRequest;a.load_callback&&"function"==typeof a.load_callback&&b.addEventListener("load",a.load_callback,!0),a.error_callback&&"function"==typeof a.error_callback&&b.addEventListener("error",a.error_callback,!0),a.state_change_callback&&"function"==typeof a.state_change_callback&&b.addEventListener("readystatechange",a.state_change_callback),a.progress_callback&&"function"==typeof a.progress_callback&&b.upload.addEventListener("progress",a.progress_callback),a.timeout_callback&&"function"==typeof a.timeout_callback&&b.addEventListener("timeout",a.timeout_callback);var c=a.url;if(a.extra_params)for(var d in a.extra_params)a.extra_params.hasOwnProperty(d)&&(c+=c.indexOf("?")!==-1?"&":"?",c+=encodeURIComponent(d)+"=",c+=encodeURIComponent(a.extra_params[d]));b.open(a.method,c);for(var e in a.headers)a.headers.hasOwnProperty(e)&&b.setRequestHeader(e,a.headers[e]);return a.body?b.send(a.body):b.send(),b};a.mule_upload=function(e){function f(a){var b=this;a=a||{},b.input=a.file_input,b.file=a.file,a.autostart=!("autostart"in a)||a.autostart,a.chunk_size=a.chunk_size||6*j,a.max_size=a.max_size||5*k,a.num_workers=a.num_workers||4,a.key=a.key||"the_key",a.bucket=a.bucket,a.access_key=a.access_key,a.content_type=a.content_type||"application/octet-stream",a.acl=a.acl||"public-read",a.on_progress=a.on_progress||function(){},a.on_chunk_progress=a.on_chunk_progress||function(){},a.on_select=a.on_select||function(){},a.on_error=a.on_error||function(){},a.on_complete=a.on_complete||function(){},a.on_init=a.on_init||function(){},a.on_start=a.on_start||function(){},a.on_chunk_uploaded=a.on_chunk_uploaded||function(){},a.ajax_base=a.ajax_base||"/upload-backend",a.accepted_extensions=a.accepted_extensions||"",b.settings=a,b.set_state("waiting"),b.input&&(b.input.onchange=function(a,c){if(!b.settings.autostart)return!0;if("waiting"!=b.get_state())return!1;var d=a.target.files[0];return b.upload_file(d,c),!0}),setTimeout(function(){b.settings.on_init.apply(b)},100)}var g=!0,h=function(){};g&&console&&console.log&&(h=function(){for(var a=["[MuleUploader]"],b=0;b<arguments.length;b++)a.push(arguments[b]);return console.log.apply(console,a)});var i=1024,j=1024*i,k=1024*j;if(File.prototype.slice=File.prototype.webkitSlice||File.prototype.mozSlice||File.prototype.slice,!(a.File&&a.FileList&&a.Blob))return h("HTML5 APIs not available."),-1;if(navigator.userAgent.indexOf("Firefox")!==-1)try{new Blob(["something"])}catch(a){return-1}return h("OK"),f.prototype.start=function(){return this.input&&this.input.files&&this.input.files.length>0?this.upload_file(this.input.files[0],!1):void alert("No file selected")},f.prototype.upload_file=function(a,e){var f=this;if("waiting"!=f.get_state())return!1;if(a&&(f.file=a),!f.file)return!1;if(f.file.lastModifiedDate=f.file.lastModifiedDate||new Date(0),f.file.size>f.settings.max_size)return alert(["The maximum allowed file size is ",f.settings.max_size/k,"GB. Please select another file."].join("")),!1;if(f.settings.accepted_extensions){for(var g=a.name.split(".").pop(),h=f.settings.accepted_extensions.split(","),i=!1,j=0;j<h.length;j++)if(g==h[j]){i=!0;break}if(!i)return alert(["This file format is not accepted. ","Please use a file with an extension like ",f.settings.accepted_extensions].join("")),!1}f.settings.on_select.call(f,a);var l=d.extend_object(f.settings.extra_params||{},{filename:a.name,filesize:a.size,content_type:a.type,last_modified:a.lastModifiedDate.valueOf()});e&&(l.force=!0),b({url:f.settings.ajax_base+"/signing_key/",extra_params:l,load_callback:function(b){var d=JSON.parse(b.target.responseText),g=/Z|\+00:?00$/.test(d.date.toString())?"":"Z";d.date=new Date(d.date+g),f.auth=d,f.upload_id=d.upload_id,f.chunks=d.chunks,f.settings.key=d.key||f.settings.key,f.settings.backup_key=f.settings.key,f.upload_id?e?f.load_file():c.list(f.auth,f.file,f.settings.key,f.upload_id,f.settings.chunk_size,function(a){for(var b=0;b<a.length;b++){var c=a[b][0]-1;f.set_progress(c,f.get_chunk_size(c)),f.set_chunk_finished(c),f.set_chunk_uploading(c,!1)}f.load_file()},function(){f.upload_id=null,this._loaded_chunks=null,f._progress=null,f._total_progress=null,f._loaded_chunks=null,f._uploading_chunks=null,f._chunks=null,f.settings.key=f.settings.backup_key,f.upload_file(a,!0)}):c.init(d,f.settings.key,a,function(a){var b=a.target.responseXML;f.upload_id=b.getElementsByTagName("UploadId")[0].textContent,f.load_file()})}})},f.prototype.load_file=function(){var a=this;if("waiting"==a.get_state()){a._start_fired||(a.settings.on_start.call(a,a.file),a.settings.on_progress.call(a,0,a.file.size),a._start_fired=!0),a.set_state("processing"),a.settings.on_progress.call(a,a.get_total_progress(),a.file.size);var b=a.get_next_chunk();b!=-1?a.upload_chunk(b):a.upload_finished()&&(h("All done; finish upload"),a.finish_upload());for(var c=0;c<a.settings.num_workers-1&&(b=a.get_next_chunk(),b!==-1);c++)a.upload_chunk(b)}},f.prototype.upload_chunk=function(a){var b=this;if("processing"!=b.get_state())return void h("NOT processing; return");if(b.get_chunk_uploading(a))return h("Already Uploading"),void setTimeout(function(){var a=b.get_next_chunk();a!==-1&&b.upload_chunk(b.get_next_chunk())},1e3);if(b.set_chunk_uploading(a),h("Uploading Chunk: "+a),b.is_chunk_loaded(a)){var d=b.get_next_chunk();d!=-1?b.upload_chunk(d):b.upload_finished()&&(h("No next chunk; finish upload"),b.finish_upload())}var e=b.settings.chunk_size,f=a*e,g=Math.min(f+e,b.file.size),i=new Date;b._intervals=b._intervals||{};var j=function(c){if(c.target.readyState!=this.DONE||"processing"!=b.get_state())return void h(c);if(c.target.status/100!=2)return m();h("Chunk uploaded: "+a),b.notify_chunk_uploaded(a),b.settings.on_chunk_uploaded.call(b,a),clearInterval(b._intervals[a]),b.set_progress(a,b.get_chunk_size(a)),b.set_chunk_finished(a),b.set_chunk_uploading(a,!1);var d=b.get_next_chunk();if(d!=-1)b.upload_chunk(d);else if(b.upload_finished())h("Done"),b.finish_upload();else var e=setInterval(function(){var a=b.get_next_chunk();a!=-1?(clearInterval(e),b.upload_chunk(a)):b.upload_finished()&&(clearInterval(e),b.finish_upload())},1e3)},k=function(c){b.set_progress(a,c.loaded),b.settings.on_progress.call(b,b.get_total_progress(),b.file.size),i=new Date},l=!1,m=function(){var c=arguments,d=this;b.check_already_uploaded(function(){b.set_state("finished"),b.notify_upload_finished(),b.settings.on_progress.call(b,b.file.size,b.file.size),b.settings.on_complete.call(b)},function(){if(h("Error: "),h(c),!l){l=!0,b.set_chunk_uploading(a,!1),b.set_chunk_finished(a,!1),b.set_progress(a,0),h("Abort");try{d.abort()}catch(a){h(a)}h("Retry chunk: "+a),clearInterval(b._intervals[a]),setTimeout(function(){if("processing"==b.get_state()){var c=b.get_next_chunk(a);c!==-1&&b.upload_chunk(c)}},1e3)}})};c.upload_chunk(b.auth,b.settings.key,b.upload_id,a,b.file.slice(f,g),{progress_callback:k,state_change_callback:j,error_callback:m,timeout_callback:m},function(c){b._chunk_xhr=b._chunk_xhr||[],b._chunk_xhr.push(c),b._intervals[a]=setInterval(function(){i&&new Date-i>15e3&&(h("Chunk Failed; retry"),clearInterval(b._intervals[a]),"processing"==b.get_state()&&(c.abort(),m.call(c),b._chunk_xhr[b._chunk_xhr.indexOf(c)]=null))},4e3)})},f.prototype.finish_upload=function(){var a=this;if("processing"==a.get_state()){a.set_state("finishing"),a.settings.on_progress.call(a,a.file.size,a.file.size);var b=function(d){d.target.status/100==2?(h("Finished file."),a.set_state("finished"),a.settings.on_progress.call(a,a.file.size,a.file.size),a.settings.on_complete.call(a)):400==d.target.status&&d.target.responseText.indexOf("EntityTooSmall")!==-1?c.list(a.auth,a.file,a.settings.key,a.upload_id,a.settings.chunk_size,function(b){a.update_chunks(b);var c=a.get_next_chunk();a.set_state("processing"),a.upload_chunk(c)}):404==d.target.status?a.cancel(function(){a.upload_file(a.file,!0)}):a.check_already_uploaded(function(){b({target:{status:200}})},function(){b({target:{status:404}})})};c.list(a.auth,a.file,a.settings.key,a.upload_id,a.settings.chunk_size,function(d){var e=Math.ceil(a.file.size/a.settings.chunk_size);if(d.length!=e){a.update_chunks(d);var f=a.get_next_chunk();return a.set_state("processing"),void a.upload_chunk(f)}c.finish(a.auth,a.file,a.settings.key,a.upload_id,d,a.settings.chunk_size,b,b)})}},f.prototype.notify_chunk_uploaded=function(a){var c=this;if("processing"==c.get_state()){var e=c.settings.key,f=c.upload_id,g=c.settings.ajax_base+"/chunk_loaded/",h=d.extend_object(c.settings.extra_params||{},{chunk:a,key:e,upload_id:f,filename:c.file.name,filesize:c.file.size,content_type:c.file.type,last_modified:c.file.lastModifiedDate.valueOf()});b({url:g,extra_params:h})}},f.prototype.check_already_uploaded=function(a,c){var e=this,f="HEAD",g="/"+e.settings.key,i=function(b){b.target.status/100==2?(h("Already Uploaded"),a()):(h("Error!"),c())};c||"function"==typeof c||(c=function(){setTimeout(function(){return e.check_already_uploaded(a,c)},2500)}),console.log(e.settings);var j="s3"+d.region_string(e.settings.region)+".amazonaws.com",k=location.protocol+"//"+j+"/"+e.settings.bucket+"/"+g;b({url:k,method:f,load_callback:i,error_callback:c})},f.prototype.cancel=function(a){for(var b=this,c=0;c<b._chunk_xhr.length;c++)h("Abort chunk: "+b._chunk_xhr[c]),b._chunk_xhr[c].abort();b._intervals=b._intervals||{};for(var d in b._intervals)b._intervals.hasOwnProperty(d)&&clearInterval(b._intervals[d]);a=a||function(){},b.set_state("canceled"),b._chunk_xhr=b._chunk_xhr||[],b.settings.on_progress.call(b,0,0),b._chunk_xhr=null,b._chunks=null,b._uploading_chunks=null,b._loaded_chunks=null,b._start_fired=!1,b.upload_id=null,b._progress=null,b.set_state("waiting"),a()},f.prototype.update_chunks=function(a){var b=this,c=[],d=Math.ceil(b.file.size/b.settings.chunk_size);b._init_chunks(!0),b._uploading_chunks=[],b._loaded_chunks=[];var e;for(e=0;e<a.length;e++){var f=parseInt(a[e][0],10);b.add_loaded_chunk(f-1),b.set_chunk_finished(f-1),c.push(f-1)}for(e=0;e<d;e++)c.indexOf(e)===-1&&(h("Chunk not uploaded: ",e),b.set_progress(e,0))},f.prototype.is_selected=function(){return!!this.file},f.prototype.get_state=function(){return this._state},f.prototype.set_state=function(a){return this._state=a,a},f.prototype.set_progress=function(a,b){this.log_status(),this._progress=this._progress||{},this._total_progress=(this._total_progress||0)+b-(this._progress[a]||0),this._progress[a]=b,this.settings.on_chunk_progress.call(this,a,b,this.get_chunk_size(a))},f.prototype.get_total_progress=function(){return this._total_progress||0},f.prototype.is_chunk_loaded=function(a){return this._loaded_chunks=this._loaded_chunks||[],this._loaded_chunks.indexOf(a)!==-1},f.prototype.add_loaded_chunk=function(a){this._loaded_chunks=this._loaded_chunks||[],this._loaded_chunks.push(a),this.set_progress(a,this.get_chunk_size(a))},f.prototype.get_chunk_uploading=function(a){return this._uploading_chunks=this._uploading_chunks||[],this._uploading_chunks.indexOf(a)!==-1},f.prototype.set_chunk_uploading=function(a,b){if("undefined"==typeof b&&(b=!0),this._uploading_chunks=this._uploading_chunks||[],b)this._uploading_chunks.push(a);else{for(var c=[],d=0;d<this._uploading_chunks.length;d++)this._uploading_chunks[d]!=a&&c.push(this._uploading_chunks[d]);this._uploading_chunks=c}},f.prototype._init_chunks=function(a){var b=this;if(!b._chunks||a){b._chunks=[];for(var c=Math.ceil(b.file.size/b.settings.chunk_size),d=0;d<c;d++)b._chunks.push(!1)}},f.prototype.set_chunk_finished=function(a,b){"undefined"==typeof b&&(b=!0);var c=this;c._init_chunks(),c._chunks[a]=b},f.prototype.get_next_chunk=function(a){var b=this;if(b._init_chunks(),a&&!b._chunks[a]&&!b.get_chunk_uploading(a))return a;for(var c=0;c<b._chunks.length;c++)if(!b._chunks[c]&&!b.get_chunk_uploading(c))return c;return-1},f.prototype.upload_finished=function(){var a=this;a._init_chunks();for(var b=0;b<a._chunks.length;b++)if(!a._chunks[b]||a.get_chunk_uploading(b))return!1;return!0},f.prototype.is_last_chunk=function(a){return Math.ceil(this.file.size/this.settings.chunk_size)-1==a},f.prototype.get_chunk_size=function(a){return this.is_last_chunk(a)?this.file.size%this.settings.chunk_size:this.settings.chunk_size},f.prototype.log_status=function(){},f.prototype.on_chunk_progress=function(a){this.settings.on_chunk_progress=a},f.prototype.on_progress=function(a){this.settings.on_progress=a},f.prototype.on_select=function(a){this.settings.on_select=a},f.prototype.on_error=function(a){this.settings.on_error=a},f.prototype.on_complete=function(a){this.settings.on_complete=a},f.prototype.on_init=function(a){this.settings.on_init=a},f.prototype.on_start=function(a){this.settings.on_start=a},f.prototype.on_chunk_uploaded=function(a){this.settings.on_chunk_uploaded=a},new f(e)};var c=function(a){this.settings=a};c.finish=function(a,b,d,e,f,g,h){for(var i={uploadId:e},j="<CompleteMultipartUpload>",k=0;k<f.length;k++)j+="<Part>",j+="<PartNumber>"+f[k][0]+"</PartNumber>",j+="<ETag>"+f[k][1]+"</ETag>",j+="</Part>";return j+="</CompleteMultipartUpload>",navigator.userAgent.indexOf("Firefox")!==-1&&(j=new Blob([j])),new c({auth:a,key:d,method:"POST",querystring:i,headers:{},payload:j,load_callback:h}).send()},c.list=function(a,b,d,e,f,g,h,i){var j={uploadId:e};return i&&(j["part-number-marker"]=i),new c({auth:a,key:d,method:"GET",querystring:j,headers:{},payload:"",error_callback:h,load_callback:function(i){if(404===i.target.status)return void(h&&h());window.debug=i;for(var j=i.target.responseXML,k=[],l=j.getElementsByTagName("Part"),m=Math.ceil(b.size/f),n=0;n<l.length;n++){var o=parseInt(l[n].getElementsByTagName("PartNumber")[0].textContent,10),p=l[n].getElementsByTagName("ETag")[0].textContent,q=parseInt(l[n].getElementsByTagName("Size")[0].textContent,10);o!=m&&q!=f||o==m&&q!=b.size%f||k.push([o,p,q])}var r=j.getElementsByTagName("IsTruncated")[0].textContent;if("true"===r){var s=j.getElementsByTagName("NextPartNumberMarker")[0].textContent;c.list(a,b,d,e,f,function(a){g(k.concat(a))},h,s)}else g(k)}}).send()},c.upload_chunk=function(a,b,d,e,f,g,h){var i,j,k,l;g instanceof Object?(i=g.load_callback,j=g.error_callback,k=g.progress_callback,l=g.state_change_callback):i=g;var m={partNumber:e+1,uploadId:d};return new c({auth:a,key:b,method:"PUT",querystring:m,headers:{},payload:f,load_callback:i,error_callback:j,progress_callback:k,state_change_callback:l}).send(h)},c.init=function(a,b,d,e){return new c({auth:a,key:b,method:"POST",querystring:{uploads:""},headers:{"x-amz-acl":"public-read","Content-Disposition":"attachment; filename="+encodeURIComponent(d.name),"Content-Type":a.content_type||"application/octet-stream"},payload:"",load_callback:e}).send()},c.prototype={send:function(a){var c=this;c.request_date=new Date,c.headers=c.settings.headers,c.headers.host=c.settings.auth.bucket+".s3"+d.region_string(c.settings.auth.region)+".amazonaws.com";var e=[c.settings.auth.date.getUTCFullYear(),d.zfill(c.settings.auth.date.getUTCMonth()+1,2),d.zfill(c.settings.auth.date.getUTCDate(),2)].join("");c.settings.querystring["X-Amz-Date"]=d.uriencode(d.iso8601(c.request_date)),c.settings.querystring["X-Amz-Algorithm"]="AWS4-HMAC-SHA256",c.settings.querystring["X-Amz-Expires"]=86400,c.settings.querystring["X-Amz-Credential"]=d.uriencode([c.settings.auth.access_key,"/"+e+"/",c.settings.auth.region+"/s3/aws4_request"].join("")),c.settings.querystring["X-Amz-SignedHeaders"]="";var f=[];for(var g in c.headers)f.push(g);f.sort(),c.settings.querystring["X-Amz-SignedHeaders"]=d.uriencode(f.join(";")),c.settings.querystring["X-Amz-Signature"]=c.get_authorization_header();var h=location.protocol+"//"+c.headers.host+"/"+c.settings.key;delete c.headers.host;var i=!0;for(var g in c.settings.querystring)c.settings.querystring.hasOwnProperty(g)&&(i&&(h+="?"),i=!1,h+=g+"="+c.settings.querystring[g]+"&");h=h.slice(0,-1);var j=b({url:h,method:c.settings.method,headers:c.headers,body:c.settings.payload,load_callback:c.settings.load_callback,progress_callback:c.settings.progress_callback,state_change_callback:c.settings.state_change_callback,error_callback:c.settings.error_callback,timeout_callback:c.settings.timeout_callback});a&&a(j)},get_authorization_header:function(){if(!this.settings.auth.date)throw"Invalid date given.";for(var a=d.get_sorted_keys(this.headers),b="",c=0;c<a.length;c++)b+=a[c].toLowerCase()+";";b=b.slice(0,-1);var e=this.get_canonical_request(),f=this.get_string_to_sign(e,this.request_date),g=this.sign_request(f);return g},get_canonical_request:function(){var a="";a+=this.settings.method.toUpperCase()+"\n",a+="/"+d.uriencode(this.settings.key).replace(/%2F/g,"/")+"\n";var b,c,e,f=d.get_sorted_keys(this.settings.querystring);for(e=0;e<f.length;e++)b=f[e],c=this.settings.querystring[b],a+=d.uriencode(b)+"="+c+"&amp;";a=a.slice(0,-"&amp;".length)+"\n";var g=d.get_sorted_keys(this.headers);for(e=0;e<g.length;e++)b=g[e],c=this.headers[b],a+=b.toLowerCase()+":"+c.trim()+"\n";for(a+="\n",e=0;e<g.length;e++)a+=g[e].toLowerCase()+";";return a=a.slice(0,-1)+"\n",a+="UNSIGNED-PAYLOAD"},get_string_to_sign:function(a,b){var c="";return c+="AWS4-HMAC-SHA256\n",c+=d.iso8601(b)+"\n",c+=[b.getUTCFullYear(),d.zfill(b.getUTCMonth()+1,2),d.zfill(b.getUTCDate(),2),"/"+this.settings.auth.region+"/s3/aws4_request\n"].join(""),c+=CryptoJS.SHA256(a.replace(/&amp;/g,"&")).toString()},sign_request:function(a){if(!this.settings.auth.signature)throw"No signature provided.";var b=CryptoJS.HmacSHA256(a,CryptoJS.enc.Hex.parse(this.settings.auth.signature)).toString();return b}};var d={uriencode:function(a){var b=encodeURIComponent(a);return b=b.replace(/[^A-Za-z0-9_.~\-%]+/g,escape),b=b.replace(/;/g,"%3B"),b=b.replace(/[*]/g,function(a){return"%"+a.charCodeAt(0).toString(16).toUpperCase()})},get_sorted_keys:function(a){var b=[];for(var c in a)a.hasOwnProperty(c)&&b.push(c);return b.sort()},iso8601:function(a){return[a.getUTCFullYear(),d.zfill(a.getUTCMonth()+1,2),d.zfill(a.getUTCDate(),2),"T",d.zfill(a.getUTCHours(),2),d.zfill(a.getUTCMinutes(),2),d.zfill(a.getUTCSeconds(),2),"Z"].join("")},zfill:function(a,b){return("00000000000"+a).substr(-b)},region_string:function(a){return a&&"us"!==a.slice(0,2)?"-"+a:""},extend_object:function(a,b){var c=a;for(var d in b)c[d]=b[d];return c}}}(this);