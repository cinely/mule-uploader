!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.muleUploader=t():e.muleUploader=t()}(window,function(){return function(e){var t={};function o(n){if(t[n])return t[n].exports;var s=t[n]={i:n,l:!1,exports:{}};return e[n].call(s.exports,s,s.exports,o),s.l=!0,s.exports}return o.m=e,o.c=t,o.d=function(e,t,n){o.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},o.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},o.t=function(e,t){if(1&t&&(e=o(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(o.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var s in e)o.d(n,s,function(t){return e[t]}.bind(null,s));return n},o.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return o.d(t,"a",t),t},o.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},o.p="",o(o.s=0)}([function(e,t,o){"use strict";o.r(t),o.d(t,"GCSUpload",function(){return i});const n="session";class s{constructor(e,t){console.log("muleUploader 2.0.0 "),this.options=Object.assign({chunkSize:52428800},t,e),this.fetchOptions={mode:this.options.backendFetchMode||"cors"}}loadFile(e){if(!e.name||!e.size)throw"not able to load file";this.file=e;let t=Math.ceil(this.file.size/this.options.chunkSize);this.chunks=[...Array(t).keys()],console.debug("File loaded",{size:this.file.size,chunks:this.chunks})}async run(){if(!this.file)throw"file not loaded"}async _uploadFile(){let e;for(;void 0!==(e=this._getNextChunk());)await this._uploadChunk(e)}async _uploadChunk(e){let t=e*this.options.chunkSize,o=Math.min(t+this.options.chunkSize,this.file.size);console.debug(`uploading chunk ${e}: ${t}-${o}`);let n=""!=this.file.type&&this.file.type||"application/octet-stream",s=`bytes ${t}-${o-1}/${this.file.size}`;return this._futch(this.session.uploadURI,{method:"PUT",body:this.file.slice(t,o),headers:{"Content-Type":n,"Content-Range":s}})}_getNextChunk(){return this.chunks.shift()}async _futch(e,t={},o){return new Promise((o,n)=>{let s=new XMLHttpRequest;s.open(t.method||"get",e);for(let e in t.headers||{})s.setRequestHeader(e,t.headers[e]);s.onload=(e=>o(e.target.responseText)),s.onerror=n,s.upload&&this.options.progressCallback&&(s.upload.onprogress=this.options.progressCallback),s.send(t.body)})}}class i extends s{constructor(e){super(e,{backendURL:"http://localhost:8081/signature",backendSecurityMode:n})}async run(){if(super.run(),this.options.backendSecurityMode!=n)throw"backend security mode not implemented";try{this.session=await this._getResumableSessionURI(),console.log("session received",this.session),await this._uploadFile()}catch(e){throw`Not able to upload, ${e}`}}async _getResumableSessionURI(){let e=new URLSearchParams;e.append("fileName",this.file.name),e.append("fileSize",this.file.size);let t=new Request(this.options.backendURL+"?"+e.toString(),{method:"GET",cache:"no-store"}),o=await fetch(t,this.fetchOptions);if(o.status<200||o.status>299)throw`error while getting signed API call: ${o.statusText}`;return o.json()}}}])});